# CRITICAL FIX: Record Not Found for Supplier+Subagent Records

**Priority:** CRITICAL  
**Type:** Bug Fix  
**Assigned to:** CODE WRITER  
**Status:** TODO

---

## üîç –ü–†–û–ë–õ–ï–ú–ê

**User Report:** "–µ—Å–ª–∏ —É –∑–∞–ø–∏—Å–∏ –æ—Ç–º–µ—á–µ–Ω–æ supplier –∏ subagent - –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–µ—Ç—Å—è, –Ω–æ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –æ—à–∏–±–∫–∞ Record not found!"

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ó–∞–ø–∏—Å—å —Å —Ä–æ–ª—è–º–∏ "supplier" –ò "subagent" —Å–æ–∑–¥–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å—å –ù–ï –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- –û—à–∏–±–∫–∞: "Record not found"
- –í—Å–µ –ø—Ä–µ–∂–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ

---

## üîç –ê–ù–ê–õ–ò–ó

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏:
1. CREATE endpoint (`app/api/directory/create/route.ts`) —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ `party`
2. –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ `partner_party` (supplier)
3. –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ `subagents` (subagent)
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏:
1. GET endpoint (`app/api/directory/[id]/route.ts`) –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–ø–∏—Å—å
2. –°—Ç—Ä–æ–∫–∞ 147: `const { data: party, error: partyError } = await query.single();`
3. –ó–∞–ø—Ä–æ—Å –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –∑–∞–ø–∏—Å—å
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404 "Record not found"

---

## üéØ –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´

### 1. Tenant Isolation (company_id –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç)
- –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å –æ–¥–Ω–∏–º `company_id`
- GET endpoint —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –¥—Ä—É–≥–æ–º—É `company_id`
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

### 2. –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- CREATE endpoint –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—Ö, –Ω–æ –∑–∞–ø–∏—Å—å –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –û—à–∏–±–∫–∞ –≤ –æ–¥–Ω–æ–π –∏–∑ role —Ç–∞–±–ª–∏—Ü –Ω–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ —á–∞—Å—Ç–∏—á–Ω–æ –∏–ª–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞

### 3. RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç –¥–æ—Å—Ç—É–ø
- –•–æ—Ç—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `supabaseAdmin`, –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å RLS
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –∑–∞–ø–∏—Å—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

### 4. UUID –∏–ª–∏ ID –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
- CREATE –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–∏–Ω ID
- GET –∏—â–µ—Ç –¥—Ä—É–≥–æ–π ID
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

---

## üîß –†–ï–®–ï–ù–ò–ï

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–æ–∑–¥–∞–Ω–∏—è

**–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (Network tab) –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å response –æ—Ç `/api/directory/create`
- –ö–∞–∫–æ–π ID –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è?
- –ï—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏?

**–í –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
- –ï—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏ –ø—Ä–∏ insert –≤ `partner_party` –∏–ª–∏ `subagents`?
- –ö–∞–∫–æ–π `company_id` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è?

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GET endpoint

**–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (Network tab) –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å request –∫ `/api/directory/[id]`
- –ö–∞–∫–æ–π ID –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è?
- –ö–∞–∫–æ–π response –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è?

**–í –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ GET endpoint
- –ö–∞–∫–æ–π `userCompanyId` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?
- –ö–∞–∫–æ–π `company_id` —É –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑–µ?

### –®–∞–≥ 3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É

**–ù–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: Tenant Isolation**

–ï—Å–ª–∏ –∑–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å –æ–¥–Ω–∏–º `company_id`, –∞ GET —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –¥—Ä—É–≥–æ–º—É:

**–§–∞–π–ª:** `app/api/directory/create/route.ts`

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- –°—Ç—Ä–æ–∫–∏ 70-90: –ö–∞–∫ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `company_id` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏?
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ `userCompanyId` –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?
- –°–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ `company_id` —Å —Ç–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç GET endpoint?

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ CREATE –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ `company_id`, —á—Ç–æ –∏ GET
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `company_id` –±–µ—Ä–µ—Ç—Å—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–§–∞–π–ª:** `app/api/directory/create/route.ts` (–ø—Ä–∏–º–µ—Ä–Ω–æ —Å—Ç—Ä–æ–∫–∏ 70-90)

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:**
```typescript
const { data: profile, error: profileError } = await supabaseAdmin
  .from("profiles")
  .select("company_id")
  .eq("user_id", user.id)
  .single();

const companyId = profile?.company_id;

const partyData = {
  // ...
  company_id: companyId,
  created_by: user.id,
  // ...
};
```

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- `company_id` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ?
- –ù–µ—Ç –ª–∏ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è?
- `companyId` –Ω–µ null/undefined?

---

## ‚úÖ –ö–†–ò–¢–ï–†–ò–ò –ü–†–ò–ï–ú–ö–ò

1. ‚úÖ –ó–∞–ø–∏—Å—å —Å —Ä–æ–ª—è–º–∏ supplier –ò subagent —Å–æ–∑–¥–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
2. ‚úÖ –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
3. ‚úÖ GET endpoint –Ω–∞—Ö–æ–¥–∏—Ç –∑–∞–ø–∏—Å—å
4. ‚úÖ `company_id` —Å–æ–≤–ø–∞–¥–∞–µ—Ç –º–µ–∂–¥—É CREATE –∏ GET
5. ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
6. ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –®–∞–≥–∏:
1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å —Å —Ä–æ–ª—è–º–∏ "supplier" –ò "subagent"
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ (–Ω–µ—Ç –æ—à–∏–±–æ–∫)
3. –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç–∫—Ä—ã—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—É—é –∑–∞–ø–∏—Å—å
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∑–∞–ø–∏—Å—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (–Ω–µ—Ç –æ—à–∏–±–æ–∫)
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–µ—Ç –æ—à–∏–±–æ–∫)

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- –ù–µ—Ç –æ—à–∏–±–æ–∫ "Record not found"

---

## üìù –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–∞–µ—Ç—Å—è:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:**
   ```sql
   -- –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–æ–∑–¥–∞–Ω–Ω—É—é –∑–∞–ø–∏—Å—å
   SELECT id, display_name, company_id, created_by, created_at
   FROM party
   ORDER BY created_at DESC
   LIMIT 1;
   
   -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ–ª–∏
   SELECT 'client' as role, party_id FROM client_party WHERE party_id = '<id>'
   UNION ALL
   SELECT 'supplier', party_id FROM partner_party WHERE party_id = '<id>'
   UNION ALL
   SELECT 'subagent', party_id FROM subagents WHERE party_id = '<id>';
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å company_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   ```sql
   SELECT user_id, company_id
   FROM profiles
   WHERE user_id = '<current_user_id>';
   ```

3. **–°—Ä–∞–≤–Ω–∏—Ç—å company_id:**
   - `party.company_id` –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å `profiles.company_id`
   - –ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ –≤ CREATE endpoint

---

**Created by:** ARCHITECT  
**Date:** 2026-01-03  
**Related:** Supplier+Subagent roles, Record not found, Tenant isolation

