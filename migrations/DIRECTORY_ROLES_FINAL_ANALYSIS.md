# –§–ò–ù–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó: Directory Roles - –ü—Ä–æ–±–ª–µ–º—ã –∏ –†–µ—à–µ–Ω–∏—è

**–î–∞—Ç–∞:** 2025-12-25  
**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É—é—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò

### 1. ‚úÖ client_party - –†–ï–®–ï–ù–û
**–°—Ç–∞—Ç—É—Å:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ  
**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π `client_type`  
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `client_type` –ø—Ä–∏ INSERT  
**–§–∞–π–ª—ã:** 
- ‚úÖ `app/api/directory/[id]/route.ts` (—Å—Ç—Ä–æ–∫–∏ 260-263) - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚ö†Ô∏è `app/api/directory/create/route.ts` - —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞

---

### 2. ‚ùå partner_party - –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

**–ù–∞–π–¥–µ–Ω–æ:**
- **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –ø–æ–ª–µ:** `partner_role` (text, NOT NULL, no default) ‚ö†Ô∏è
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
- API –∫–æ–¥ –ù–ï –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç `partner_role` –ø—Ä–∏ INSERT

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã:**
```
party_id              - uuid, NOT NULL (‚úÖ API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç)
partner_role          - text, NOT NULL, no default (‚ùå API –ù–ï –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç!)
is_active             - boolean, nullable, default true
business_category     - enum, nullable
commission_type       - enum, nullable
commission_value      - numeric, nullable
commission_currency   - text, nullable, default 'EUR'
commission_valid_from - date, nullable
commission_valid_to   - date, nullable
commission_notes      - text, nullable
created_at, updated_at - timestamptz, —Å defaults
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// –¢–µ–∫—É—â–∏–π API –∫–æ–¥ (app/api/directory/[id]/route.ts —Å—Ç—Ä–æ–∫–∞ 270):
const supplierData: any = { party_id: id }; // ‚ùå –ù–ï–¢ partner_role!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- INSERT –±—É–¥–µ—Ç –ø–∞–¥–∞—Ç—å —Å –æ—à–∏–±–∫–æ–π: `null value in column "partner_role" violates not-null constraint`

---

### 3. ‚ùå subagents - –ü–†–û–ë–õ–ï–ú–ê –ù–ï–°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø

**–ù–∞–π–¥–µ–Ω–æ:**
- –ù–ï–¢ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (–∫—Ä–æ–º–µ `party_id`)
- API –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–ª–æ–Ω–∫–∏, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ —Ç–∞–±–ª–∏—Ü–µ

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã (–†–ï–ê–õ–¨–ù–ê–Ø):**
```
id               - serial, —Å default (‚úÖ)
party_id         - uuid, NOT NULL (‚úÖ API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç)
commission_type  - ??? (–µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ)
commission_value - numeric, nullable (–µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ)
currency         - text, nullable (–µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ)
is_active        - boolean, nullable (–µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ)
created_at, updated_at - timestamptz, —Å defaults
```

**API –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç (–ù–û –ö–û–õ–û–ù–û–ö –ù–ï–¢):**
- `commission_scheme` - ‚ùå –ù–ï–¢ –≤ —Ç–∞–±–ª–∏—Ü–µ
- `commission_tiers` - ‚ùå –ù–ï–¢ –≤ —Ç–∞–±–ª–∏—Ü–µ
- `payout_details` - ‚ùå –ù–ï–¢ –≤ —Ç–∞–±–ª–∏—Ü–µ

**–ü—Ä–æ–±–ª–µ–º–∞:**
```typescript
// –¢–µ–∫—É—â–∏–π API –∫–æ–¥ (app/api/directory/[id]/route.ts —Å—Ç—Ä–æ–∫–∏ 289-291):
if (updates.subagent_details.commission_scheme) subagentData.commission_scheme = ...; // ‚ùå –ö–æ–ª–æ–Ω–∫–∏ –Ω–µ—Ç!
if (updates.subagent_details.commission_tiers) subagentData.commission_tiers = ...;   // ‚ùå –ö–æ–ª–æ–Ω–∫–∏ –Ω–µ—Ç!
if (updates.subagent_details.payout_details) subagentData.payout_details = ...;        // ‚ùå –ö–æ–ª–æ–Ω–∫–∏ –Ω–µ—Ç!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- INSERT –±—É–¥–µ—Ç –ø–∞–¥–∞—Ç—å —Å –æ—à–∏–±–∫–æ–π: `column "commission_scheme" does not exist`

---

## üéØ –¢–†–ï–ë–£–ï–ú–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –ü–†–ò–û–†–ò–¢–ï–¢ 1: partner_party - partner_role (–ö–†–ò–¢–ò–ß–ù–û)

**–ü—Ä–æ–±–ª–µ–º–∞:** API –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ `partner_role`

**–í–æ–ø—Ä–æ—Å –¥–ª—è Architect:** –ö–∞–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–ª—è `partner_role`?

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
- A) –í—Å–µ–≥–¥–∞ 'supplier' (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
- B) –û–ø—Ä–µ–¥–µ–ª—è—Ç—å –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ roles –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –¥–∞–Ω–Ω—ã—Ö)
- C) –î–æ–±–∞–≤–∏—Ç—å –≤ API payload –Ω–æ–≤–æ–µ –ø–æ–ª–µ `partner_role`

**–†–µ—à–µ–Ω–∏–µ –¥–ª—è CODE WRITER:**
```typescript
// –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∏—è –æ—Ç Architect, –æ–±–Ω–æ–≤–∏—Ç—å:
// app/api/directory/[id]/route.ts —Å—Ç—Ä–æ–∫–∞ ~270
// app/api/directory/create/route.ts —Å—Ç—Ä–æ–∫–∞ ~193

const supplierData: any = { 
  party_id: id,
  partner_role: 'supplier' // –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ä–µ—à–µ–Ω–∏—è Architect
};
```

---

### –ü–†–ò–û–†–ò–¢–ï–¢ 2: subagents - –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–ª–æ–Ω–æ–∫

**–ü—Ä–æ–±–ª–µ–º–∞:** API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–ª–æ–Ω–∫–∏, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ

**–í–æ–ø—Ä–æ—Å –¥–ª—è Architect:** –ö–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –≤—ã–±—Ä–∞—Ç—å?

**–í–ê–†–ò–ê–ù–¢ A: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—É (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)**
- –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:
  - `commission_scheme` (enum: 'revenue', 'profit')
  - `commission_tiers` (jsonb)
  - `payout_details` (text)
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏: `.ai/tasks/directory-v1-full-architecture.md`

**–í–ê–†–ò–ê–ù–¢ B: –ò—Å–ø—Ä–∞–≤–∏—Ç—å API –∫–æ–¥**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏:
  - `commission_type` –≤–º–µ—Å—Ç–æ `commission_scheme`
  - `commission_value` (–µ—Å—Ç—å)
  - `currency` –≤–º–µ—Å—Ç–æ `payout_details`
  - –£–±—Ä–∞—Ç—å `commission_tiers`
- –ù–ï —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–∞—Ä–∏–∞–Ω—Ç A (–¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏), —Ç–∞–∫ –∫–∞–∫:
1. –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç —ç—Ç–∏ –∫–æ–ª–æ–Ω–∫–∏
2. API –∫–æ–¥ —É–∂–µ –Ω–∞–ø–∏—Å–∞–Ω –ø–æ–¥ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é
3. –õ–µ–≥—á–µ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏, —á–µ–º –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å API

---

## üìã –ß–ï–ö–õ–ò–°–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:
- [x] client_party client_type - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ UPDATE endpoint
- [x] –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü - –∑–∞–≤–µ—Ä—à–µ–Ω–∞

### ‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è:
- [ ] **ARCHITECT:** –†–µ—à–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è partner_party.partner_role
- [ ] **ARCHITECT:** –†–µ—à–∏—Ç—å –ø–æ–¥—Ö–æ–¥ –¥–ª—è subagents (–¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å API)
- [ ] **DB/SUPABASE:** –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è partner_role (–µ—Å–ª–∏ —Ä–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å default –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É)
- [ ] **DB/SUPABASE:** –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è subagents –∫–æ–ª–æ–Ω–æ–∫ (–µ—Å–ª–∏ —Ä–µ—à–µ–Ω–∏–µ: –í–∞—Ä–∏–∞–Ω—Ç A)
- [ ] **CODE WRITER:** –î–æ–±–∞–≤–∏—Ç—å partner_role –≤ INSERT –¥–ª—è partner_party
- [ ] **CODE WRITER:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å API –∫–æ–¥ –¥–ª—è subagents (–µ—Å–ª–∏ —Ä–µ—à–µ–Ω–∏–µ: –í–∞—Ä–∏–∞–Ω—Ç B)
- [ ] **CODE WRITER:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å client_type –≤ create endpoint

---

## üìÅ –§–ê–ô–õ–´ –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### API —Ñ–∞–π–ª—ã:
1. `app/api/directory/[id]/route.ts`
   - –°—Ç—Ä–æ–∫–∞ ~270: –î–æ–±–∞–≤–∏—Ç—å `partner_role` –≤ `supplierData`
   - –°—Ç—Ä–æ–∫–∏ 289-291: –ò—Å–ø—Ä–∞–≤–∏—Ç—å `subagentData` (—É–±—Ä–∞—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ —Ç–∞–±–ª–∏—Ü—É)

2. `app/api/directory/create/route.ts`
   - –°—Ç—Ä–æ–∫–∞ ~193: –î–æ–±–∞–≤–∏—Ç—å `partner_role` –≤ `supplierData`
   - –°—Ç—Ä–æ–∫–∏ 219-221: –ò—Å–ø—Ä–∞–≤–∏—Ç—å `subagentData`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ `client_type` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ client_party

### –ú–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è):
- `migrations/add_partner_role_fix.sql` - –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å default –¥–ª—è partner_role
- `migrations/add_subagents_columns.sql` - –µ—Å–ª–∏ —Ä–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –≤ subagents

---

## üö® –ö–†–ò–¢–ò–ß–ù–û–°–¢–¨

1. **partner_party.partner_role** - –ö–†–ò–¢–ò–ß–ù–û (INSERT –ø–∞–¥–∞–µ—Ç)
2. **subagents –∫–æ–ª–æ–Ω–∫–∏** - –í–´–°–û–ö–ê–Ø (INSERT –ø–∞–¥–∞–µ—Ç, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∂–µ)

---

## üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **ARCHITECT** –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è:
   - –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è `partner_role` –≤ `partner_party`
   - –ü–æ–¥—Ö–æ–¥ –¥–ª—è `subagents` (–¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å API)

2. –ü–æ—Å–ª–µ —Ä–µ—à–µ–Ω–∏–π:
   - DB/SUPABASE —Å–æ–∑–¥–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   - CODE WRITER –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç API –∫–æ–¥

3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
   - –°–æ–∑–¥–∞–Ω–∏–µ party —Å —Ä–æ–ª—å—é "supplier" ‚Üí –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
   - –°–æ–∑–¥–∞–Ω–∏–µ party —Å —Ä–æ–ª—å—é "subagent" ‚Üí –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π ‚Üí –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å





